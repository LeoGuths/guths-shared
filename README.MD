# Guths.Shared

Uma biblioteca compartilhada para aplica√ß√µes .NET que fornece funcionalidades comuns e reutiliz√°veis para projetos web, APIs e sistemas distribu√≠dos.

## üöÄ Funcionalidades

- **Sistema de Result Pattern** - Padroniza√ß√£o de retornos com valida√ß√µes
- **Autentica√ß√£o JWT** - Configura√ß√£o e utilit√°rios para autentica√ß√£o
- **Pagina√ß√£o** - DTOs e helpers para pagina√ß√£o de dados
- **MongoDB Integration** - Generic Repository pattern e configura√ß√µes
- **Storage Services** - Integra√ß√£o com Amazon S3
- **Web Utilities** - Controllers base, Endpoints helper, formatters e middlewares
- **Localiza√ß√£o** - Suporte multi-idioma
- **Logging** e Observabilidade - Logger customizado, tracing e m√©tricas
- **Resili√™ncia HTTP** - Pol√≠ticas de retry e circuit breaker
- **AWS Parameter Store** - Integra√ß√£o para configura√ß√µes seguras

## üîß Instala√ß√£o

```bash
dotnet add package Guths.Shared
```

## üìã Configura√ß√£o B√°sica

### 1. Program.cs

```csharp
using Guths.Shared.Configuration;

var builder = WebApplication.CreateBuilder(args);

// Configura√ß√£o b√°sica (carrega automaticamente do appsettings.json)
builder.Services.AddSharedConfiguration();

var app = builder.Build();

// Configurar pipeline da aplica√ß√£o
app.AddSharedConfiguration("ScalarTitle");

app.Run();
```

### 2. Configura√ß√£o com Pol√≠ticas de Autoriza√ß√£o Customizadas

```csharp
using Guths.Shared.Configuration;

var builder = WebApplication.CreateBuilder(args);

// Configura√ß√£o com pol√≠ticas customizadas
var sharedConfigurationOptions = new SharedConfigurationOptions
{
    ConfigureAuthorization = options =>
    {
        options.AddPolicy("SystemScope", policy =>
        {
            policy.RequireClaim("role", "system");
            policy.RequireClaim("scope", "send_email");
        });
        
        options.AddPolicy("AdminOnly", policy => policy.RequireRole("Admin"));
    }
};

builder.Services.AddSharedConfiguration(sharedConfigurationOptions);

var app = builder.Build();

app.AddSharedConfiguration("ScalarTitle");

app.Run();
```

### 3. appsettings.json ou AWS Parameter Store

#### Configura√ß√£o M√≠nima Obrigat√≥ria

```json
{
  "SharedConfiguration": {
    "UseAwsParameterStore": false
  },
  "AmazonParameterStorePaths": [
    "/NomeDoProjeto",
    "/Commons",
    "/etc"
  ]
}
```

> ‚ö†Ô∏è **Importante**: As se√ß√µes `SharedConfiguration` e `AmazonParameterStorePaths` s√£o **obrigat√≥rias** no `appsettings.json`. A primeira controla se o AWS Parameter Store ser√° usado, e a segunda define os caminhos a serem buscados (necess√°ria apenas se for usar AWS para evitar exceptions).

#### Configura√ß√£o Completa

```json
{
  "SharedConfiguration": {
    "UseAwsParameterStore": true,
    "UseDefaultHttpResilience": true,
    "UseGlobalExceptionHandler": true,
    "UseCache": true,
    "UseAuth": true,
    "UseCors": true,
    "UseControllers": true,
    "UseLocalization": true,
    "UseScalar": true,
    "LoggingConfiguration": {
      "UseCustomLogger": true,
      "UseTracing": true,
      "UseMetrics": true
    }
  },
  "AmazonParameterStorePaths": [
    "/NomeDoProjeto",
    "/Commons",
    "/etc"
  ],
  "AuthSettings": {
    "Issuer": "https://meudominio.com",
    "Audience": "minha-api",
    "SecretKey": "sua-chave-secreta-aqui",
    "AccessTokenExpirationInMinutes": 30,
    "RefreshTokenExpirationInDays": 7,
    "CookieName": "AuthToken"
  },
  "DatabaseConnection": {
    "MongoDbConnectionString": "mongodb://localhost:27017",
    "MongoDbDatabaseName": "MeuDatabase"
  },
  "RedisConnection": {
    "Host": "localhost:6379",
    "User": "default",
    "Password": "sua-senha-redis"
  },
  "StorageOptions": {
    "BucketName": "meu-bucket"
  },
  "OpenTelemetry": {
    "Provider": "Grafana",
    "Grafana": {
      "ServiceName": "minha-api",
      "ServiceNamespace": "meu-namespace",
      "ApiKey": "sua-api-key-grafana",
      "TracesEndpoint": "https://traces-prod-us-central1.grafana.net/tempo",
      "MetricsEndpoint": "https://prometheus-us-central1.grafana.net/api/prom",
      "LogsEndpoint": "https://logs-prod-us-central1.grafana.net/loki"
    }
  }
}
```
> üîí **Recomenda√ß√£o de Seguran√ßa**: Dados sens√≠veis como senhas, chaves de API e tokens **n√£o devem** ser armazenados no `appsettings.json` em produ√ß√£o ou em projetos abertos. Use AWS Parameter Store/Secrets Manager, Key Vault ou outras solu√ß√µes seguras de gerenciamento de segredos.

### 4. Configura√ß√µes via AWS Parameter Store

Quando `UseAwsParameterStore` est√° habilitado, as configura√ß√µes podem ser armazenadas no AWS Systems Manager Parameter Store seguindo os padr√µes:

#### Autentica√ß√£o
```
/{NomeDoProjeto}/AuthSettings/SecretKey
/{NomeDoProjeto}/AuthSettings/RefreshTokenExpirationInDays
/{NomeDoProjeto}/AuthSettings/Issuer
/{NomeDoProjeto}/AuthSettings/AccessTokenExpirationInMinutes
/{NomeDoProjeto}/AuthSettings/CookieName
/{NomeDoProjeto}/AuthSettings/Audience
```

#### Banco de Dados
```
/{NomeDoProjeto}/DatabaseConnection/MongoDbConnectionString
/{NomeDoProjeto}/DatabaseConnection/MongoDbDatabaseName
```

#### Cache Redis
```
/{NomeDoProjeto}/RedisConnection/Password
/{NomeDoProjeto}/RedisConnection/User
/{NomeDoProjeto}/RedisConnection/Host
```

#### Storage
```
/{NomeDoProjeto}/StorageOptions/BucketName
```

#### OpenTelemetry
```
/{NomeDoProjeto}/OpenTelemetry/Provider
/{NomeDoProjeto}/OpenTelemetry/Grafana/ApiKey
/{NomeDoProjeto}/OpenTelemetry/Grafana/TracesEndpoint
/{NomeDoProjeto}/OpenTelemetry/Grafana/ServiceNamespace
/{NomeDoProjeto}/OpenTelemetry/Grafana/MetricsEndpoint
/{NomeDoProjeto}/OpenTelemetry/Grafana/LogsEndpoint
/{NomeDoProjeto}/OpenTelemetry/Grafana/ServiceName
```

#### Configura√ß√µes Compartilhadas
```
/Commons/DatabaseConnection/MongoDbConnectionString
/Commons/RedisConnection/Host
/etc/GlobalSettings/Environment
```

## ‚öôÔ∏è Op√ß√µes de Configura√ß√£o

### SharedConfiguration

OBS: O valor padr√£o de todos os par√¢metros abaixo √© `false`.
```text
UseAwsParameterStore        -> Carrega configura√ß√µes do AWS Parameter Store
UseDefaultHttpResilience    -> Habilita pol√≠ticas padr√£o de resili√™ncia HTTP
UseGlobalExceptionHandler   -> Middleware global de tratamento de exce√ß√µes
UseCache                    -> Servi√ßos de cache distribu√≠do
UseAuth                     -> Autentica√ß√£o JWT
UseCors                     -> Configura√ß√£o de CORS
UseControllers              -> Registra controllers automaticamente
UseLocalization             -> Suporte a localiza√ß√£o com StringLocalizer
UseScalar                   -> Documenta√ß√£o de API com Scalar e OpenAPI
LoggingConfiguration        -> Configura√ß√µes de logging e observabilidade (Se encontrado a sess√£o LoggingConfiguration, pelo menos o logging ser√° habilitado automaticamente)
```

### LoggingConfiguration

OBS: O valor padr√£o de todos os par√¢metros abaixo √© `false`.
```text
UseCustomLogger -> Logger customizado
UseTracing      -> Distributed tracing
UseMetrics      -> M√©tricas da aplica√ß√£o
```

## üõ†Ô∏è Exemplos de Uso

### Result Pattern

```csharp
public class UserController : MyControllerBase
{
    [HttpGet("{id}")]
    public async Task<IActionResult> GetUser(int id)
    {
        var result = await _userService.GetUserByIdAsync(id);
        return CustomGetResponse(result);
    }
    
    [HttpPost]
    public async Task<IActionResult> CreateUser(CreateUserRequest request)
    {
        var result = await _userService.CreateUserAsync(request);
        return CustomPostResponse(result);
    }
}
```

### Pagina√ß√£o

```csharp
public async Task<Result<PaginationResult<User>>> GetUsersAsync(PaginationInput pagination)
{
    var users = await _repository.GetPagedAsync(pagination);
    var totalCount = await _repository.CountAsync();
    
    return Result<PaginationResult<User>>.Success(new PaginationResult<User>
    {
        Items = users,
        Pagination = new PaginationData
        {
            PageNumber = pagination.PageNumber,
            PageSize = pagination.PageSize,
            TotalRecords = totalCount
        }
    });
}
```

### MongoDB Repository

```csharp
public class UserRepository : MongoDbRepository<User>
{
    public UserRepository(IMongoClientManager clientManager) 
        : base(clientManager, "users")
    {
    }
    
    public async Task<User?> GetByEmailAsync(string email)
    {
        return await Collection
            .Find(x => x.Email == email)
            .FirstOrDefaultAsync();
    }
}
```

### Storage Service

```csharp
public class DocumentService
{
    private readonly IStorageService _storageService;
    
    public DocumentService(IStorageService storageService)
    {
        _storageService = storageService;
    }
    
    public async Task<string> UploadDocumentAsync(Stream fileStream, string fileName)
    {
        return await _storageService.UploadFileAsync(fileStream, fileName);
    }
}
```

## üåê Localiza√ß√£o

### Configura√ß√£o

```json
{
  "SharedConfiguration": {
    "UseLocalization": true
  }
}
```

```csharp
builder.Services.AddSharedConfiguration();
```

### Uso

```csharp
public class UserService
{
    private readonly IStringLocalizer<Global> _localizer;
    
    public UserService(IStringLocalizer<Global> localizer)
    {
        _localizer = localizer;
    }
    
    public Result<User> ValidateUser(User user)
    {
        if (string.IsNullOrEmpty(user.Email))
        {
            return Result<User>.Failure(_localizer["EmailRequired"]);
        }
        
        return Result<User>.Success(user);
    }
}
```

## üîê Autentica√ß√£o

### Configura√ß√£o Autom√°tica

```json
{
  "SharedConfiguration": {
    "UseAuth": true
  }
}
```

```csharp
var sharedConfigurationOptions = new SharedConfigurationOptions
{
    ConfigureAuthorization = options =>
    {
        options.AddPolicy("SystemScope", policy =>
        {
            policy.RequireClaim("role", "system");
            policy.RequireClaim("scope", "send_email");
        });
        
        options.AddPolicy("AdminOnly", policy => policy.RequireRole("Admin"));
    }
};

builder.Services.AddSharedConfiguration(sharedConfigurationOptions);
```

### Acesso ao Token

```csharp
public class MyService
{
    private readonly AuthTokenAccessor _tokenAccessor;
    
    public MyService(AuthTokenAccessor tokenAccessor)
    {
        _tokenAccessor = tokenAccessor;
    }
    
    public async Task<string> GetUserInfoAsync()
    {
        var token = _tokenAccessor.AccessToken;
        // Usar token para chamadas externas
    }
}
```

## üìä Observabilidade

### Configura√ß√£o

```json
{
  "SharedConfiguration": {
    "LoggingConfiguration": {
      "UseCustomLogger": true,
      "UseTracing": true,
      "UseMetrics": true
    }
  }
}
```

### Recursos Inclusos (OpenTelemetry)

A biblioteca utiliza **OpenTelemetry** como padr√£o para observabilidade, proporcionando flexibilidade total para escolher seus exporters e backends:

- **Logging Estruturado** - Logs padronizados e estruturados
- **Distributed Tracing** - Rastreamento de requisi√ß√µes entre servi√ßos
- **M√©tricas** - Coleta autom√°tica de m√©tricas da aplica√ß√£o
- **Health Checks** - Endpoints de sa√∫de da aplica√ß√£o

## üîÑ Resili√™ncia HTTP

### Configura√ß√£o

```json
{
  "SharedConfiguration": {
    "UseDefaultHttpResilience": true
  }
}
```

### Recursos

- **Retry Policies** - Tentativas autom√°ticas em falhas tempor√°rias
- **Circuit Breaker** - Prote√ß√£o contra cascata de falhas
- **Timeout** - Controle de tempo limite de requisi√ß√µes
- **Bulkhead** - Isolamento de recursos

## üìö Recursos Autom√°ticos

### Middleware de Usu√°rio Autenticado
- Ativo quando `UseAuth = true`
- Popula informa√ß√µes do usu√°rio no contexto automaticamente

### Exception Handler Global
- Ativo quando `UseGlobalExceptionHandler = true`
- Trata todas as exce√ß√µes de forma padronizada
- Habilita suporte para ProblemException

### Formatters Customizados
- Suporte autom√°tico para `text/plain`
- √ötil para webhooks e integra√ß√µes

### Documenta√ß√£o com Scalar
- Ativo quando `UseScalar = true`
- Interface moderna para documenta√ß√£o de APIs

## ü§ù Contribuindo

1. Fa√ßa um fork do projeto
2. Crie uma branch para sua feature (`git checkout -b feature/nova-funcionalidade`)
3. Commit suas mudan√ßas (`git commit -am 'Adiciona nova funcionalidade'`)
4. Push para a branch (`git push origin feature/nova-funcionalidade`)
5. Crie um Pull Request

## üèóÔ∏è Roadmap

- [x] Testes automatizados
- [x] Integra√ß√£o com AWS Systems Manager para armazenar segredos
- [x] M√©tricas e observabilidade
- [x] Logger customizado
- [ ] Integra√ß√£o com Azure Key Vault

## üìß Contato

Para d√∫vidas ou sugest√µes, abra uma issue no reposit√≥rio.

---

‚≠ê **Se este projeto foi √∫til para voc√™, considere dar uma estrela!**